================================================================================
                         VS1024 - 対戦型2048ゲーム 設計書
                                    v2.6
================================================================================

【概要】
--------------------------------------------------------------------------------
VS1024は、クラシックな2048パズルゲームに対戦要素を加えたリアルタイムバトルゲーム。
プレイヤーとCPUが同時進行でプレイし、攻撃・妨害・スキルを駆使して相手のHPを0にする。

【公開URL】
https://159265moneys.github.io/vs1024/

================================================================================
                                基本ルール
================================================================================

【HP システム】
- 両者初期HP: 5
- 勝利条件: 相手のHPを0にする
- 敗北条件: 自分のHPが0になる

【攻撃アクション（タップで発動、タイル消費）】
┌─────────┬────────────────────────────────────────┐
│  タイル  │              効果                      │
├─────────┼────────────────────────────────────────┤
│   128   │ 妨害ブロック ×1 を相手に送る           │
│   512   │ 1ダメージ + 妨害ブロック ×3            │
│  1024   │ 4ダメージ（必殺技）                    │
└─────────┴────────────────────────────────────────┘

【自動妨害（タイル生成時に自動発動）】
- 256を作成 → 相手に妨害ブロック ×1（タイルは残る）

【妨害ブロック】
- 妨害は「3秒後に届く」警告付き
- プレイヤーには画面上部に警告バー表示
- 妨害ブロックは相手盤面に「2」として配置

【詰み時の処理】
- 盤面が動かせなくなる → HP -2
- すべての「2」タイルを削除
- ゲーム続行（盤面リセットではない）

【マッチポイント】
- HP 1になった側の盤面枠が光る
- 視覚的な緊張感を演出

================================================================================
                               スキルシステム
================================================================================

【発動条件】
- 任意のタイル合成時に 5% の確率でランダム発動
- 重み付きランダム選択（下記比率）

【スキル一覧（合計重み: 100）】
┌────────────┬─────────────────────────────────┬────────┬────────────┐
│   スキル   │            効果                 │  重み  │  実質確率  │
├────────────┼─────────────────────────────────┼────────┼────────────┤
│ 🛡️ シールド │ 次に受ける攻撃ダメージを無効化  │    5   │   0.25%    │
│ 🪞 リフレクト│ 次に受ける妨害を相手に跳ね返す  │   20   │   1.00%    │
│ 🧹 クリーン │ 両者の盤面の「2」を全消し       │   10   │   0.50%    │
│ ⚡ ダブル   │ 次の攻撃ダメージを2倍にする     │    5   │   0.25%    │
│ 💣 ボム    │ 相手盤面に爆弾設置（後述）      │   15   │   0.75%    │
│ ❄️ フリーズ │ 相手を3秒間操作不能にする       │   20   │   1.00%    │
│ 🔄 コンバート│ 自分の「2」を1つ「4」に変換     │   10   │   0.50%    │
│ 🎲 ダイス  │ 2~128からランダムで1種全消し    │   15   │   0.75%    │
└────────────┴─────────────────────────────────┴────────┴────────────┘

【ボムスキル詳細】
- 相手盤面にボムタイル（2/4/8ランダム）を設置
- 3秒以内に合成できなければ爆発
- 爆発時: ボムを中心とした3×3エリアのタイルを全削除
- 合成に成功すればボム解除

【スキル弾演出】
- スキル発動時、合成したタイル位置から相手盤面へ弾が飛ぶ
- プレイヤー: シアン色
- CPU: 赤色

================================================================================
                                CPU AI
================================================================================

【レベル別特性】
┌────────┬──────────────────────────────────────────────────────┐
│ Level  │                    AI特性                            │
├────────┼──────────────────────────────────────────────────────┤
│   1    │ ランダム移動。攻撃確率50%。                          │
│   2    │ 基本戦略（下・左優先）。高タイル即攻撃。              │
│   3    │ コーナー戦略（左・下優先）。状況に応じた攻撃判断。    │
│   4    │ 評価関数使用。HP・空きマスを考慮した攻撃判断。        │
│   5    │ 2手先読み。最適手探索。高度な攻撃タイミング判断。     │
└────────┴──────────────────────────────────────────────────────┘

【AI操作速度（ミリ秒）】
- Level 1: 600-1000ms
- Level 2: 450-750ms
- Level 3: 300-600ms
- Level 4: 150-350ms
- Level 5: 80-200ms

【AIスキル発動】
- プレイヤーと同条件（5%確率でランダム発動）

================================================================================
                              ファイル構成
================================================================================

2048/
├── index.html          # メインHTML（166行）
├── manifest.json       # PWA設定
├── VS1024.txt          # 本設計書
├── css/
│   └── style.css       # スタイルシート（912行）
└── js/
    ├── skills.js       # スキル定義・重み付き選択（97行）
    ├── board.js        # 盤面管理クラス（509行）
    ├── game.js         # ゲームコントローラー（633行）
    ├── ai.js           # CPU AIロジック（446行）
    ├── ui.js           # UI管理クラス（236行）
    └── main.js         # メイン初期化・イベント処理（245行）

================================================================================
                              クラス設計
================================================================================

【Board クラス】(board.js)
┌─────────────────────────────────────────────────────────────────────────────┐
│ プロパティ                                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ size          : number      - 盤面サイズ（4×4）                             │
│ grid          : number[][]  - 盤面状態                                      │
│ score         : number      - スコア                                        │
│ tiles         : object[]    - タイルDOM参照                                 │
│ element       : HTMLElement - 盤面DOM要素                                   │
│ isPlayer      : boolean     - プレイヤー盤面フラグ                          │
│ interferenceTiles : Set     - 妨害タイル位置                                │
│ bombTiles     : Map         - ボムタイル情報                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ メソッド                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ init(element, isPlayer)              - 盤面初期化                           │
│ move(direction)                      - タイル移動（戻り値: moved, merges）  │
│ addRandomTile(value, isInterference) - ランダム位置にタイル追加             │
│ removeTile(row, col)                 - タイル削除                           │
│ clearAllTwos()                       - 全ての2を削除                        │
│ clearAllWithValue(value)             - 指定値のタイル全削除                 │
│ convertRandomTwoToFour()             - ランダムな2を4に変換                 │
│ addBombTile()                        - ボムタイル追加（2/4/8ランダム）      │
│ updateBombs(deltaTime)               - ボムタイマー更新                     │
│ explodeBomb(row, col)                - 3×3範囲爆破                          │
│ canMove()                            - 移動可能判定                         │
│ getMaxTile()                         - 最大タイル値取得                     │
│ getAttackableTiles()                 - 攻撃可能タイル一覧                   │
│ refreshTilePositions()               - タイル位置再計算                     │
└─────────────────────────────────────────────────────────────────────────────┘

【Game クラス】(game.js)
┌─────────────────────────────────────────────────────────────────────────────┐
│ プロパティ                                                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│ playerBoard / enemyBoard : Board    - 両者の盤面                            │
│ playerHP / enemyHP       : number   - HP                                    │
│ playerScore / enemyScore : number   - スコア                                │
│ interferenceQueue        : array    - 妨害キュー（タイマー付き）            │
│ playerShield / enemyShield   : bool - シールド状態                          │
│ playerReflect / enemyReflect : bool - リフレクト状態                        │
│ playerDouble / enemyDouble   : bool - ダブル状態                            │
│ playerFrozen / enemyFrozen   : bool - フリーズ状態                          │
│ skillChance              : number   - スキル発動確率（0.05 = 5%）           │
├─────────────────────────────────────────────────────────────────────────────┤
│ コールバック                                                                │
├─────────────────────────────────────────────────────────────────────────────┤
│ onHPChange, onScoreChange, onGameOver, onInterferenceWarning,               │
│ onDamage, onBoardReset, onEnemyBoardUpdate, onBattleLog,                    │
│ onMatchPoint, onFreezeChange, onSkillBullet                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│ メソッド                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ init(playerEl, enemyEl, level)       - ゲーム初期化                         │
│ playerMove(direction)                - プレイヤー移動処理                   │
│ handlePlayerAttack(value, row, col)  - プレイヤー攻撃処理                   │
│ handleCPUAttack(value, row, col)     - CPU攻撃処理                          │
│ checkSkillTrigger(caster, row, col)  - スキル発動チェック                   │
│ executeSkill(skillId, caster)        - スキル実行                           │
│ addInterferenceToPlayer/Enemy(count) - 妨害追加                             │
│ checkAndHandleStuck(target)          - 詰み判定・処理                       │
│ endGame(winner)                      - ゲーム終了                           │
└─────────────────────────────────────────────────────────────────────────────┘

【AI クラス】(ai.js)
┌─────────────────────────────────────────────────────────────────────────────┐
│ メソッド                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ start() / stop()                     - AI開始/停止                          │
│ makeMove()                           - 移動実行                             │
│ getBestMove()                        - レベル別最適手取得                   │
│ getRandomMove()                      - Lv1: ランダム                        │
│ getBasicMove()                       - Lv2: 基本戦略                        │
│ getCornerMove()                      - Lv3: コーナー戦略                    │
│ getSmartMove()                       - Lv4: 評価関数                        │
│ getExpertMove()                      - Lv5: 先読み探索                      │
│ evaluateGrid(grid)                   - 盤面評価（空きマス・モノトニシティ） │
│ considerAttack()                     - 攻撃判断                             │
│ shouldAttack(value)                  - 攻撃すべきか判定                     │
└─────────────────────────────────────────────────────────────────────────────┘

【UI クラス】(ui.js)
┌─────────────────────────────────────────────────────────────────────────────┐
│ メソッド                                                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ init()                               - DOM要素キャッシュ                    │
│ updateHP(target, hp)                 - HPバー更新                           │
│ updateScore(target, score)           - スコア更新                           │
│ showDamage(target, amount)           - ダメージエフェクト                   │
│ showInterferenceWarning(count, timer)- 妨害警告バー                         │
│ showBoardReset(target, count)        - 2消去エフェクト                      │
│ showBattleLog(message, type)         - バトルログ表示                       │
│ updateMatchPoint(playerHP, enemyHP)  - マッチポイント枠光り                 │
│ setFrozen(target, frozen)            - フリーズオーバーレイ                 │
│ showSkillBullet(caster, row, col, icon, board) - スキル弾演出               │
│ resetGame()                          - UI初期化                             │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
                              イベントフロー
================================================================================

【ゲーム開始】
1. CPU対戦ボタン押下
2. showScreen('game')  ← 先に画面表示（DOM計算のため）
3. Game.init() → Board初期化 × 2
4. requestAnimationFrame × 2 でレイアウト確定後タイル位置再計算
5. AI.start()
6. ゲームループ開始

【プレイヤー移動】
1. スワイプ/キー入力
2. Game.playerMove(direction)
3. Board.move() → 移動・合成処理
4. 合成があれば checkSkillTrigger() → 5%で executeSkill()
5. 256生成チェック → 自動妨害
6. 新タイル追加
7. 詰み判定

【攻撃】
1. 攻撃タイル(128/512/1024)タップ
2. handlePlayerAttack()
3. シールド判定 → ダブル判定 → ダメージ適用
4. 妨害送付（あれば）
5. HP0判定 → 終了

【妨害】
1. addInterferenceToPlayer/Enemy()
2. キューに追加（timer: 3.0秒）
3. 毎フレームupdateInterferenceQueue()でタイマー減少
4. timer <= 0 でリフレクト判定 → 盤面に2追加

【スキル発動】
1. 合成時 5%判定
2. getWeightedRandomSkill() で重み付き選択
3. executeSkill() で効果適用
4. onSkillBullet → UI.showSkillBullet() で弾演出

================================================================================
                              UI/UX設計
================================================================================

【カラーパレット】
- 背景: #0a0a0f（ダーク）
- アクセント: #00f5ff（シアン）、#ff00aa（ピンク）、#ff3366（レッド）
- タイル: 2048準拠 + カスタムグラデーション

【レスポンシブ】
- プレイヤー盤面: min(88vw, 340px)
- 敵盤面: min(68vw, 210px)
- 小画面(max-width:400px): サイズ縮小
- 低い画面(max-height:650px): さらに縮小

【PWA対応】
- manifest.json でインストール可能
- standalone表示
- iOS Safari「ホーム画面に追加」対応

【タッチ操作】
- スワイプ: 最小30px
- 短タップ（200ms以内、移動20px以内）: 攻撃タイルタップ
- passive: true でスクロール最適化

================================================================================
                              技術仕様
================================================================================

【ブラウザサポート】
- iOS Safari 12+
- Chrome 80+
- Firefox 75+

【パフォーマンス】
- requestAnimationFrame によるゲームループ
- CSS transition でタイルアニメーション
- DOM要素の再利用（updateDOM）

【注意点】
- タイル位置はCSS gridではなく絶対位置（position: absolute）
- サイズ計算はgetTilePosition()で動的に算出
- 画面表示後にタイル位置を再計算（UI崩壊防止）

================================================================================
                              更新履歴
================================================================================

v2.6 (2024/12)
- スキル発動確率 3% → 5%
- ボムタイルの値をランダム化（2/4/8）
- GitHub Pages公開

v2.5
- スキル弾演出追加
- UI崩壊バグ修正

v2.4
- スキルシステム再導入（重み付きランダム）
- フリーズ・ボムスキル実装

v2.3
- スキル完全削除
- 妨害・攻撃のみのシンプル版

v2.2
- 敵盤面表示追加
- バトルログ追加
- マッチポイント演出

v2.1
- 数値しきい値調整（128/256/512/1024）
- 詰み時HP-2 & 2全消し

v2.0
- 対戦システム実装
- CPU AI Lv1-5

v1.0
- 基本2048実装

================================================================================
                                   EOF
================================================================================

